# Minimal docker-compose for building and running vLLM with ROCm gfx1151
# Removes version declaration for docker compose plugin compatibility

services:
  # Build and run vLLM service
  vllm:
    #build:
    #  context: .
    #  dockerfile: Dockerfile
    image: openmtx/vllm-rocm-dev-gfx1151:latest
    container_name: vllm-rocm-dev-gfx1151
    privileged: true
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    group_add:
      - video
    ports:
      - "8080:8080"
    environment:
      - VLLM_TARGET_DEVICE=rocm
      - VLLM_ATTENTION_BACKEND=triton
      - HSA_OVERRIDE_GFX_VERSION=11.5.1
      - VLLM_ALLOW_LONG_MAX_MODEL_LEN=1
      - HSA_XNACK=1
      - ROC_ENABLE_PRE_VEGA=1
      - OMP_NUM_THREADS=32
      - FLASH_ATTENTION_TRITON_AMD_ENABLE=TRUE
    volumes:
      - ./cache/huggingface:/root/.cache/huggingface
      - /dev/shm:/dev/shm
    command: >
      vllm serve Qwen/Qwen2.5-0.5B-Instruct
      --host 0.0.0.0
      --port 8080
      --tensor-parallel-size 1
