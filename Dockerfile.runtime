# syntax=docker/dockerfile:1

FROM ubuntu:24.04

LABEL maintainer="ken@epenguin.com" \
      description="vLLM runtime for AMD gfx1151 (Strix Halo) - Built from pre-download wheels"

ENV DEBIAN_FRONTEND=noninteractive


# Install minimal runtime dependencies
# Note: gcc, make, libc6-dev, and python3-dev are required for Triton AMD backend JIT compilation
# The Triton AMD backend compiles HIP utilities at runtime using C compiler
# libc6-dev provides standard C library headers like stdint.h
# python3-dev provides Python development headers like Python.h
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.12 \
    python3.12-venv \
    python3-dev \
    curl \
    ca-certificates \
    google-perftools \
    libatomic1 \
    libgomp1 \
    gcc \
    make \
    libc6-dev \
  && rm -rf /var/lib/apt/lists/*

# Configure TCMalloc system-wide
RUN TCMALLOC_PATH="/usr/lib/x86_64-linux-gnu/libtcmalloc.so.4" && \
    if [ -f "$TCMALLOC_PATH" ]; then \
        echo "$TCMALLOC_PATH" | tee /etc/ld.so.preload > /dev/null && \
        echo "TCMalloc configured: $(cat /etc/ld.so.preload)"; \
    else \
        echo "WARNING: TCMalloc not found"; \
    fi

# Set environment for vLLM
ENV HSA_OVERRIDE_GFX_VERSION="11.5.1" \
    VLLM_TARGET_DEVICE="rocm" \
    FLASH_ATTENTION_TRITON_AMD_ENABLE="TRUE"

# Create virtual environment
RUN python3.12 -m venv /opt/venv
ENV PATH="/opt/venv/bin:${PATH}"

RUN pip install --index-url https://rocm.nightlies.amd.com/v2/gfx1151/ "rocm[libraries,devel]" \
 && pip install --pre --index-url https://rocm.nightlies.amd.com/v2/gfx1151/ torch torchaudio torchvision \
 && rocm-sdk init \
 && (cd /opt/venv/lib/python3.12/site-packages/_rocm_sdk_core/share/amd_smi; pip install .)

RUN ROCM_SDK_PATH=$(rocm-sdk path --bin) && \
    ROCM_LIB_PATH=$(dirname "$ROCM_SDK_PATH")/lib && \
    echo "$ROCM_LIB_PATH" > /etc/ld.so.conf.d/rocm-sdk.conf && \
    ldconfig

# TODO - 01
# Add $(rocm-sdk path --bin) into env PATH so the tools like hipcc++ can be found

# Copy wheels (provided at build time)
COPY ./wheels/*.whl /tmp/

# Install wheels using ROCm extra index URL
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir --extra-index-url https://rocm.nightlies.amd.com/v2/gfx1151/ /tmp/*.whl && \
    rm /tmp/*.whl

# Verify installation
# RUN /opt/venv/bin/python -c "import vllm; print(f'vLLM version: {vllm.__version__}')" && \
#    pip list | grep -E "(vllm|amd_aiter|flash_attn)"

# Expose default port for vLLM API server
EXPOSE 8080

# Default command
CMD ["/opt/venv/bin/vllm", "--help"]
